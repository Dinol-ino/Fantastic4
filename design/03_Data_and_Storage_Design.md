# 03 Data and Storage Design

## 1. Cloud Storage: Firestore (NoSQL)

Firestore is the primary database for application state, user management, and fast querying.

### Collections & Schema

#### `users`
*   `uid` (string, PK): Firebase Auth UID
*   `email` (string)
*   `walletAddress` (string): Connected MetaMask address
*   `role` (string): 'admin' | 'investor'
*   `createdAt` (timestamp)

#### `properties`
Synced with on-chain data but enriched with off-chain details.
*   `propertyId` (string, PK): Generated by Firestore
*   `tokenId` (number): On-chain NFT ID (assigned after minting)
*   `title` (string)
*   `description` (string)
*   `location` (string)
*   `totalValuation` (number): In MATIC
*   `pricePerShare` (number): In MATIC
*   `totalShares` (number)
*   `availableShares` (number)
*   `ipfsMetadataUrl` (string): Link to Pinata JSON
*   `images` (array of strings): IPFS URLs
*   `status` (string): 'DRAFT' | 'TOKENIZED' | 'SOLD_OUT'
*   `ownerWallet` (string)

#### `transactions`
*   `txHash` (string, PK)
*   `type` (string): 'MINT' | 'INVEST' | 'WITHDRAW'
*   `propertyId` (string)
*   `buyerAddress` (string)
*   `amountPaid` (number)
*   `sharesPurchased` (number)
*   `timestamp` (timestamp)
*   `status` (string): 'PENDING' | 'SUCCESS' | 'FAILED'

#### `notifications`
*   `id` (auto-id)
*   `userId` (string)
*   `message` (string)
*   `read` (boolean)
*   `type` (string): 'EMAIL_SENT' | 'SYSTEM'

## 2. Decentralized Storage: IPFS (via Pinata)

Used for immutable storage of asset documents and metadata.

### Storage Strategy
*   **Images**: Property photos are uploaded individually.
*   **Documents**: Legal deeds/papers (PDFs) uploaded.
*   **Metadata JSON**: Follows ERC-721 standard. Uploaded *after* images/docs.

### Metadata JSON Structure
```json
{
  "name": "Luxury Apartment #402",
  "description": "2BHK in center of Mumbai",
  "image": "ipfs://QmImageHash...",
  "attributes": [
    { "trait_type": "Location", "value": "Mumbai" },
    { "trait_type": "Valuation", "value": "5000 MATIC" },
    { "trait_type": "Documents", "value": "ipfs://QmDocHash..." }
  ]
}
```

## 3. Data Flow & Sync

1.  **Drafting**: Admin creates property in Firestore (`status: DRAFT`).
2.  **To Chain**: Application uploads metadata to Pinata, gets Hash.
3.  **Minting**: Admin signs transaction with Hash. Smart Contract mints NFT.
4.  **Sync**: Backend Listener detects `PropertyTokenized` event.
    *   Updates Firestore `properties` doc with `tokenId` and sets `status: TOKENIZED`.

## 4. Security & Privacy
*   **Documents**: For the hackathon, we assume public IPFS links. For production, Pinata "Submarining" (Private IPFS) would be used.
*   **Firestore Rules**:
    *   `read`: Public for properties; Owners only for user profiles.
    *   `write`: Admin only for properties (verified by Custom Claims or Backend RBAC).
